<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Leitor QR - Concreto</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111827">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0b1220; --card:#111827; --card2:#0f172a;
      --line:#1f2937; --line2:#243244; --text:#e5e7eb; --muted:#94a3b8;
      --blue:#1d4ed8; --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width: 580px; margin:0 auto; padding: 14px; padding-bottom: 26px; }
    .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 6px 0 12px; }
    .title{ font-size: 16px; font-weight: 850; letter-spacing:.2px; }
    .pill{
      padding:6px 10px; border-radius:999px; background:var(--card2);
      border:1px solid var(--line2); color:var(--muted); font-size:12px;
      display:flex; align-items:center; gap:6px;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background:var(--muted); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius: 18px; padding: 12px; box-shadow: var(--shadow); }
    .grid{ display:grid; gap:10px; }
    .hint{ color:var(--muted); font-size:12px; line-height: 1.25rem; }
    .ops{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border:1px solid var(--line2); background:var(--card2); color:var(--text);
      padding:12px 12px; border-radius: 14px; font-weight: 800; cursor:pointer;
      flex: 1; min-width: 120px; user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{ background:var(--blue); border-color:var(--blue); }
    .btn.good{ background:#16a34a; border-color:#16a34a; }
    .btn.bad{ background:#b91c1c; border-color:#b91c1c; }
    .btn.sel{ outline: 2px solid #60a5fa; }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .kv{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .field{ background:var(--card2); border:1px solid var(--line2); border-radius: 14px; padding:10px; }
    .label{ color:var(--muted); font-size: 11px; }
    .value{ font-weight: 850; margin-top:4px; font-size: 14px; letter-spacing:.2px; }
    #reader{ width:100%; overflow:hidden; border-radius: 18px; border:1px solid var(--line); background:#000; }
    .statusLine{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .status{ font-weight: 900; letter-spacing:.2px; }
    .status.ok{ color: var(--ok); } .status.err{ color: var(--err); } .status.warn{ color: var(--warn); }
    .divider{ height:1px; background: var(--line); margin: 4px 0; opacity:.8; }
    .hidden{ display:none; }
    .log{ display:grid; gap:8px; }
    .logItem{ padding:10px; border-radius: 14px; background:var(--card2); border:1px solid var(--line2); }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; color:#cbd5e1; white-space:pre-wrap; word-break:break-word;
    }

    /* MPA input */
    .mpaBox{
      background:var(--card2);
      border:1px solid var(--line2);
      border-radius: 16px;
      padding: 12px;
      display:grid;
      gap:8px;
    }
    .mpaRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .mpaInput{
      width: 100%;
      font-size: 22px;
      font-weight: 900;
      padding: 14px 14px;
      border-radius: 14px;
      border:1px solid var(--line2);
      background:#0b1220;
      color:var(--text);
      outline:none;
    }
    .mpaInput::placeholder{ color:#64748b; font-weight:700; }
    .mpaHelp{ color:var(--muted); font-size: 12px; line-height: 1.2rem; }
    .footerHint{ margin-top: 10px; color: var(--muted); font-size: 11px; line-height: 1.25rem; text-align:center; }
  </style>

  <!-- Scanner QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">üì∑ Leitor de QR ‚Ä¢ Registro MPA</div>
      <div class="pill"><span class="dot" id="connDot"></span><span id="connTxt">offline</span></div>
    </div>

    <div class="card grid">
      <div class="hint">
        1) Selecione o operador ‚Ä¢ 2) <b>Ler QR</b> ‚Ä¢ 3) Digite <b>MPA</b> ‚Ä¢ 4) <b>Salvar</b>
      </div>

      <div class="ops" id="ops">
        <button class="btn" data-op="Gabriel">Gabriel</button>
        <button class="btn" data-op="Tawan">Tawan</button>
        <button class="btn" data-op="Ricardo">Ricardo</button>
      </div>

      <div class="row">
        <button class="btn primary" id="btnStart">Ler QR</button>
        <button class="btn" id="btnNew">Nova leitura</button>
      </div>

      <div id="reader" class="hidden"></div>

      <div class="statusLine">
        <div class="hint">Status: <span id="status" class="status">aguardando</span></div>
        <div class="hint">Operador: <b id="opView">‚Äî</b></div>
      </div>

      <div class="divider"></div>

      <div class="hint"><b>Pr√©via do QR</b></div>
      <div class="kv">
        <div class="field"><div class="label">Tra√ßo_ID</div><div class="value" id="pv_traco">‚Äî</div></div>
        <div class="field"><div class="label">CP</div><div class="value" id="pv_cp">‚Äî</div></div>
        <div class="field"><div class="label">Data Moldagem</div><div class="value" id="pv_mold">‚Äî</div></div>
        <div class="field"><div class="label">Hora Moldagem</div><div class="value" id="pv_hora">‚Äî</div></div>
        <div class="field"><div class="label">Idade (dias)</div><div class="value" id="pv_idade">‚Äî</div></div>
        <div class="field"><div class="label">Data Ruptura</div><div class="value" id="pv_rupt">‚Äî</div></div>
      </div>

      <div class="divider"></div>

      <div class="mpaBox">
        <div class="row">
          <div class="hint"><b>MPA (resist√™ncia medida)</b></div>
          <div class="hint">Obrigat√≥rio</div>
        </div>

        <input
          id="mpaInput"
          class="mpaInput"
          inputmode="decimal"
          autocomplete="off"
          placeholder="Ex: 21,5"
        />

        <div class="mpaHelp">
          Aceita v√≠rgula ou ponto. Ex.: <b>21,5</b> = <b>21.5</b>
        </div>

        <button class="btn good" id="btnSave" disabled>Salvar na planilha</button>
      </div>

      <div class="divider"></div>

      <div class="hint"><b>√öltimas leituras</b></div>
      <div id="logBox" class="log"></div>

      <div class="footerHint">
        Dica: Instale como app ‚Üí Chrome (Android) ‚ãÆ ‚Üí ‚ÄúAdicionar √† tela inicial‚Äù.
      </div>
    </div>
  </div>

<script>
/***********************
 * CONFIGURA√á√ïES
 ***********************/
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyDzgeU-ECAw4Gn3uTeQXPLM1nqINAMLgPHBxa72FXpXsazYt3Z8uZJLK-XZbv7Mqeg/exec";

// ‚ö†Ô∏è precisa ser IGUAL no Code.gs
const API_TOKEN  = "TROQUE_ESSE_TOKEN_123";

/***********************
 * ESTADO
 ***********************/
let selectedOp = "";
let html5Qr = null;
let scanning = false;

// Guardamos o √∫ltimo QR lido (para salvar depois com MPA)
let lastRaw = "";
let lastParsed = null;

/***********************
 * HELPERS
 ***********************/
const $ = (id) => document.getElementById(id);

function setStatus(text, type="") {
  const el = $("status");
  el.textContent = text;
  el.className = "status " + (type || "");
}

function setConn() {
  const online = navigator.onLine;
  $("connTxt").textContent = online ? "online" : "offline";
  $("connDot").style.background = online ? "#22c55e" : "#94a3b8";
}
window.addEventListener("online", setConn);
window.addEventListener("offline", setConn);
setConn();

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function fillPreview(p) {
  $("pv_traco").textContent = p?.traco_id || "‚Äî";
  $("pv_cp").textContent    = p?.cp || "‚Äî";
  $("pv_mold").textContent  = p?.data_moldagem || "‚Äî";
  $("pv_hora").textContent  = p?.hora_moldagem || "‚Äî";
  $("pv_idade").textContent = (p?.idade_dias !== "" && p?.idade_dias != null) ? p.idade_dias : "‚Äî";
  $("pv_rupt").textContent  = p?.data_ruptura || "‚Äî";
}

function pushLog(entry) {
  const dt = new Date().toLocaleString();
  const div = document.createElement("div");
  div.className = "logItem";
  div.innerHTML = `
    <div class="row">
      <div class="hint">${entry.ok ? "‚úÖ OK" : "‚ùå ERRO"} ‚Ä¢ ${dt}</div>
      <div class="hint">Op: <b>${escapeHtml(entry.operador || "")}</b></div>
    </div>
    <div class="hint" style="margin-top:6px;">MPA: <b>${escapeHtml(entry.mpa || "‚Äî")}</b></div>
    <div class="mono" style="margin-top:8px;">${escapeHtml(entry.raw || "")}</div>
  `;
  $("logBox").prepend(div);
  while ($("logBox").children.length > 6) $("logBox").removeChild($("logBox").lastChild);
}

function normalizaData(v) {
  if (!v) return "";
  const s = String(v).trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    const [y, m, d] = s.split("-");
    return `${d}/${m}/${y}`;
  }
  return s;
}

/***********************
 * PARSE DO QR (UNIVERSAL)
 * Suporta:
 * - key=value com separadores | ; \n ,
 *   ex: traco=21663|cp=2/2|idade=28|mold=2026-01-05|hora=13:24|rupt=2026-02-02
 * - fallback: "Tra√ßo: 21663" (caso exista algum)
 ***********************/
function parseQR(raw) {
  const out = {
    traco_id: "",
    cp: "",
    data_moldagem: "",
    hora_moldagem: "",
    idade_dias: "",
    data_ruptura: "",
    qr_raw: raw
  };
  if (!raw) return out;

  const text = String(raw).replace(/\r/g, "");

  // 1) key=value
  const norm = text.replace(/\n/g, "|").replace(/;/g, "|").replace(/,/g, "|");
  const parts = norm.split("|").map(p => p.trim()).filter(Boolean);

  const kv = {};
  for (const p of parts) {
    const eq = p.indexOf("=");
    if (eq > 0) {
      const k = p.slice(0, eq).trim().toLowerCase();
      const v = p.slice(eq + 1).trim();
      if (k) kv[k] = v;
    }
  }

  const pick = (...keys) => {
    for (const k of keys) if (kv[k] != null && kv[k] !== "") return kv[k];
    return "";
  };

  const tracoKV = pick("traco", "tra√ßo", "traco_id", "tra√ßo_id");
  const cpKV    = pick("cp");
  const idadeKV = pick("idade", "idade_dias", "idade-dias");
  const moldKV  = pick("mold", "moldagem", "data_mold", "data_moldagem");
  const horaKV  = pick("hora", "hora_mold", "hora_moldagem");
  const ruptKV  = pick("rupt", "ruptura", "data_rupt", "data_ruptura");

  if (tracoKV || cpKV || idadeKV || moldKV || horaKV || ruptKV) {
    out.traco_id = tracoKV;
    out.cp = cpKV;
    out.idade_dias = idadeKV;
    out.hora_moldagem = horaKV;
    out.data_moldagem = normalizaData(moldKV);
    out.data_ruptura = normalizaData(ruptKV);
    return out;
  }

  // 2) fallback "Tra√ßo: ..."
  const traco = text.match(/Tra√ßo:\s*([0-9]+)/i);
  if (traco) out.traco_id = traco[1];

  const cp = text.match(/CP:\s*([0-9\/]+)/i);
  if (cp) out.cp = cp[1];

  const mold = text.match(/Moldagem:\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4})/i);
  if (mold) out.data_moldagem = mold[1];

  const hora = text.match(/Hora:\s*([0-9]{2}:[0-9]{2})/i);
  if (hora) out.hora_moldagem = hora[1];

  const idade = text.match(/([0-9]+)\s*DIAS?/i);
  if (idade) out.idade_dias = idade[1];

  const rupt = text.match(/Ruptura:\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4})/i);
  if (rupt) out.data_ruptura = rupt[1];

  return out;
}

/***********************
 * MPA: normaliza√ß√£o e valida√ß√£o
 ***********************/
function normalizeMPA(input) {
  // aceita "21,5" -> "21.5"
  const s = String(input || "").trim().replace(",", ".");
  // remove caracteres estranhos, mantendo d√≠gitos e ponto
  const cleaned = s.replace(/[^0-9.]/g, "");
  if (!cleaned) return "";
  // evita m√∫ltiplos pontos: mant√©m o primeiro
  const firstDot = cleaned.indexOf(".");
  if (firstDot !== -1) {
    const before = cleaned.slice(0, firstDot + 1);
    const after  = cleaned.slice(firstDot + 1).replace(/\./g, "");
    return before + after;
  }
  return cleaned;
}

function isValidMPA(mpaStr) {
  if (!mpaStr) return false;
  const v = Number(mpaStr);
  // voc√™ pode ajustar limites aqui (ex: 0 a 100)
  return Number.isFinite(v) && v > 0 && v < 200;
}

function updateSaveButton() {
  const mpa = normalizeMPA($("mpaInput").value);
  const ok = !!lastParsed && !!lastRaw && isValidMPA(mpa);
  $("btnSave").disabled = !ok;
}

/***********************
 * OPERADOR
 ***********************/
document.querySelectorAll("#ops .btn").forEach(b => {
  b.addEventListener("click", () => {
    document.querySelectorAll("#ops .btn").forEach(x => x.classList.remove("sel"));
    b.classList.add("sel");
    selectedOp = b.dataset.op;
    $("opView").textContent = selectedOp;
    if ($("status").textContent === "selecione operador") setStatus("aguardando");
  });
});

/***********************
 * BOT√ïES
 ***********************/
$("btnStart").addEventListener("click", async () => {
  if (!selectedOp) {
    setStatus("selecione operador", "err");
    return;
  }
  startScan();
});

$("btnNew").addEventListener("click", async () => {
  // reseta tudo
  lastRaw = "";
  lastParsed = null;
  $("mpaInput").value = "";
  fillPreview(null);
  updateSaveButton();
  setStatus("aguardando", "");
});

$("mpaInput").addEventListener("input", () => {
  // normaliza enquanto digita (sem ficar ‚Äúpulando‚Äù demais)
  updateSaveButton();
});

$("btnSave").addEventListener("click", async () => {
  const mpa = normalizeMPA($("mpaInput").value);
  if (!isValidMPA(mpa)) {
    setStatus("MPA inv√°lido", "err");
    return;
  }
  if (!lastParsed || !lastRaw) {
    setStatus("leia um QR primeiro", "err");
    return;
  }
  await sendToSheet(lastRaw, lastParsed, mpa);
});

/***********************
 * SCANNER
 ***********************/
async function startScan() {
  setStatus("abrindo c√¢mera...", "");
  $("btnStart").disabled = true;
  $("reader").classList.remove("hidden");

  if (!html5Qr) html5Qr = new Html5Qrcode("reader");

  try {
    scanning = true;

    const config = { fps: 12, qrbox: { width: 260, height: 260 } };
    const cams = await Html5Qrcode.getCameras();
    const backCam = cams && cams.length ? cams[cams.length - 1].id : undefined;

    await html5Qr.start(
      backCam,
      config,
      async (decodedText) => {
        await stopScan();

        const parsed = parseQR(decodedText);
        fillPreview(parsed);

        // valida√ß√£o m√≠nima do QR
        if (!parsed.traco_id || !parsed.cp || !parsed.data_moldagem || !parsed.hora_moldagem) {
          lastRaw = decodedText;
          lastParsed = parsed;
          updateSaveButton();
          setStatus("QR lido, mas faltam campos (verifique o QR)", "err");
          pushLog({ ok:false, raw: decodedText, operador: selectedOp, mpa:"" });
          $("btnStart").disabled = false;
          return;
        }

        lastRaw = decodedText;
        lastParsed = parsed;

        setStatus("QR lido ‚úÖ digite o MPA e clique Salvar", "warn");
        // foca no MPA pra agilizar
        $("mpaInput").focus();
        updateSaveButton();
      },
      () => {}
    );

    setStatus("aponte para o QR", "");
  } catch (e) {
    scanning = false;
    $("btnStart").disabled = false;
    setStatus("erro c√¢mera: " + (e?.message || e), "err");
  }
}

async function stopScan() {
  try {
    if (html5Qr && scanning) {
      await html5Qr.stop();
      await html5Qr.clear();
    }
  } catch {}
  scanning = false;
  $("reader").classList.add("hidden");
}

/***********************
 * ENVIO
 ***********************/
async function sendToSheet(raw, parsed, mpaStr) {
  try {
    setStatus("salvando na planilha...", "warn");
    $("btnSave").disabled = true;
    $("btnStart").disabled = true;

    const payload = {
      token: API_TOKEN,
      timestamp: new Date().toISOString(),
      operador: selectedOp,
      mpa: mpaStr,
      ...parsed,
      qr_raw: raw
    };

    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));

    if (data.ok) {
      setStatus("gravado na planilha ‚úÖ", "ok");
      pushLog({ ok:true, raw, operador: selectedOp, mpa: mpaStr });

      // prepara pr√≥xima leitura (mas n√£o abre c√¢mera automaticamente)
      // voc√™ pode clicar em Nova leitura e depois Ler QR
      // (se quiser, eu altero pra abrir c√¢mera autom√°tico ap√≥s salvar)
      lastRaw = "";
      lastParsed = null;
      $("mpaInput").value = "";
      fillPreview(null);
      updateSaveButton();

    } else {
      setStatus("falhou: " + (data.error || "erro"), "err");
      pushLog({ ok:false, raw, operador: selectedOp, mpa: mpaStr });
      updateSaveButton();
    }
  } catch (e) {
    setStatus("erro envio: " + (e?.message || e), "err");
    pushLog({ ok:false, raw, operador: selectedOp, mpa: mpaStr });
    updateSaveButton();
  } finally {
    $("btnStart").disabled = false;
  }
}

/***********************
 * PWA (Service Worker)
 ***********************/
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}
</script>
</body>
</html>
