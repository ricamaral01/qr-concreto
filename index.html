<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Leitor QR - Concreto</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111827">

  <style>
    :root { --bg:#0b1220; --card:#111827; --muted:#94a3b8; --ok:#22c55e; --err:#ef4444; }
    * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:var(--bg); color:#e5e7eb; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 14px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 8px 0 12px; }
    .title { font-size: 16px; font-weight: 700; }
    .pill { padding:6px 10px; border-radius:999px; background:#0f172a; color:var(--muted); font-size:12px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius: 16px; padding: 12px; }
    .grid { display:grid; gap:10px; }
    .ops { display:flex; gap:8px; flex-wrap:wrap; }
    .btn {
      border:1px solid #243244; background:#0f172a; color:#e5e7eb;
      padding:10px 12px; border-radius: 14px; font-weight:600; cursor:pointer;
      flex: 1; min-width: 120px;
    }
    .btn.primary { background:#1d4ed8; border-color:#1d4ed8; }
    .btn.sel { outline: 2px solid #60a5fa; }
    .small { color:var(--muted); font-size:12px; }
    #reader { width:100%; border-radius: 16px; border:1px solid #1f2937; }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); }
    .hidden { display:none; }
  </style>

  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="title">ðŸ“· Leitor QR â€¢ Concreto</div>
    <div class="pill" id="connPill">offline</div>
  </div>

  <div class="card grid">
    <div class="small">Selecione o operador â†’ Leia o QR â†’ Salva automÃ¡tico</div>

    <div class="ops" id="ops">
      <button class="btn" data-op="Gabriel">Gabriel</button>
      <button class="btn" data-op="Tawan">Tawan</button>
      <button class="btn" data-op="Ricardo">Ricardo</button>
    </div>

    <button class="btn primary" id="btnStart">Ler QR</button>
    <button class="btn" id="btnNew" disabled>Nova leitura</button>

    <div id="reader" class="hidden"></div>

    <div class="small">
      Status: <span id="status">aguardando</span><br>
      Operador: <b id="opView">â€”</b>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzuaiWoLjd2TviQggQa4dLt2z5-qLetX2p7yxXyLEBBEjT5VL5zyrndebtB58RcOHtq/exec";
const API_TOKEN  = "qrConcreto_2026_Concrefer@01";

/* ================= APP ================= */
let operador = "";
let qr;

const $ = id => document.getElementById(id);

document.querySelectorAll("#ops .btn").forEach(b => {
  b.onclick = () => {
    document.querySelectorAll("#ops .btn").forEach(x => x.classList.remove("sel"));
    b.classList.add("sel");
    operador = b.dataset.op;
    $("opView").textContent = operador;
  };
});

$("btnStart").onclick = async () => {
  if (!operador) return setStatus("Selecione operador", true);
  $("reader").classList.remove("hidden");
  qr = new Html5Qrcode("reader");

  const cams = await Html5Qrcode.getCameras();
  await qr.start(
    cams[cams.length - 1].id,
    { fps: 10, qrbox: 250 },
    async txt => {
      await qr.stop();
      $("reader").classList.add("hidden");
      enviar(txt);
    }
  );
};

$("btnNew").onclick = () => location.reload();

function setStatus(msg, err=false){
  const s = $("status");
  s.textContent = msg;
  s.className = err ? "status err" : "status ok";
}

async function enviar(raw){
  setStatus("Enviando...");
  const payload = {
    token: API_TOKEN,
    operador,
    qr_raw: raw,
    timestamp: new Date().toISOString()
  };

  const r = await fetch(WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  const j = await r.json();
  if(j.ok){
    setStatus("Gravado na planilha âœ”");
    $("btnNew").disabled = false;
  } else {
    setStatus("Erro: " + j.error, true);
  }
}

/* conexÃ£o */
function conn(){
  $("connPill").textContent = navigator.onLine ? "online" : "offline";
}
window.addEventListener("online", conn);
window.addEventListener("offline", conn);
conn();
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>
</body>
</html>
