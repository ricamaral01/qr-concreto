<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QR Concreto â€¢ Registro MPA</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#070A12">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg1:#070A12; --bg2:#0B1020;
      --card:rgba(15,22,48,.9); --card2:rgba(11,18,38,.95);
      --line:#1E2A4A; --line2:#2A3A66;
      --text:#F3F6FF; --muted:#A9B4D0;
      --blue:#3B82F6; --ok:#22C55E; --err:#EF4444; --warn:#F59E0B;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0; color:var(--text);
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .wrap{ max-width: 700px; margin:0 auto; padding: 18px; }
    .title{ font-size: 22px; font-weight: 900; }
    .subtitle{ color:var(--muted); font-size:14px; margin-bottom:12px; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
      display:grid;
      gap:14px;
    }

    .ops{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      padding:16px;
      border-radius:16px;
      border:1px solid var(--line2);
      background:var(--card2);
      color:var(--text);
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      flex:1;
    }
    .btn.primary{ background:#2563EB; }
    .btn.good{ background:#16A34A; }
    .btn.sel{ outline:3px solid #60A5FA; }

    #reader{
      width:100%;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--line);
      background:#000;
    }

    .status{ font-weight:900; font-size:16px; }
    .ok{ color:var(--ok); }
    .err{ color:var(--err); }
    .warn{ color:var(--warn); }

    .kv{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ background:var(--card2); border:1px solid var(--line2); border-radius:14px; padding:12px; }
    .label{ font-size:12px; color:var(--muted); }
    .value{ font-size:18px; font-weight:900; margin-top:6px; }

    .mpaInput{
      font-size:34px;
      font-weight:900;
      padding:18px;
      border-radius:16px;
      border:1px solid var(--line2);
      background:#050814;
      color:var(--text);
      width:100%;
    }
  </style>

  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
<div class="wrap">
  <div class="title">ðŸ“· QR Concreto</div>
  <div class="subtitle">Ler QR â†’ Digitar MPA â†’ Salvar</div>

  <div class="card">

    <div class="ops" id="ops">
      <button class="btn" data-op="Gabriel">Gabriel</button>
      <button class="btn" data-op="Tawan">Tawan</button>
      <button class="btn" data-op="Ricardo">Ricardo</button>
    </div>

    <button class="btn primary" id="btnStart">Ler QR</button>

    <div id="reader" style="display:none"></div>

    <div>Status: <span id="status" class="status">aguardando</span></div>

    <div class="kv">
      <div class="field"><div class="label">TraÃ§o</div><div id="pv_traco" class="value">â€”</div></div>
      <div class="field"><div class="label">CP</div><div id="pv_cp" class="value">â€”</div></div>
      <div class="field"><div class="label">Idade</div><div id="pv_idade" class="value">â€”</div></div>
      <div class="field"><div class="label">Moldagem</div><div id="pv_mold" class="value">â€”</div></div>
      <div class="field"><div class="label">Hora</div><div id="pv_hora" class="value">â€”</div></div>
      <div class="field"><div class="label">Ruptura</div><div id="pv_rupt" class="value">â€”</div></div>
    </div>

    <input id="mpaInput" class="mpaInput" placeholder="MPA (ex: 21,5)" />

    <button class="btn good" id="btnSave" disabled>ðŸ’¾ SALVAR</button>

  </div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyDzgeU-ECAw4Gn3uTeQXPLM1nqINAMLgPHBxa72FXpXsazYt3Z8uZJLK-XZbv7Mqeg/exec";

let operador = "";
let lastRaw = "";
let lastParsed = null;
let qr = null;

const $ = id => document.getElementById(id);
const status = (t,c="") => { $("status").textContent=t; $("status").className="status "+c; };

document.querySelectorAll("#ops .btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("#ops .btn").forEach(x=>x.classList.remove("sel"));
    b.classList.add("sel");
    operador=b.dataset.op;
  };
});

$("btnStart").onclick=async()=>{
  if(!operador){ status("selecione operador","err"); return; }
  $("reader").style.display="block";
  qr ??= new Html5Qrcode("reader");
  await qr.start({facingMode:"environment"},{fps:10,qrbox:300},txt=>{
    qr.stop();
    $("reader").style.display="none";
    lastRaw=txt;
    lastParsed=parseQR(txt);
    preview(lastParsed);
    status("QR lido","warn");
    $("btnSave").disabled=false;
  });
};

$("btnSave").onclick=()=>send();

function parseQR(raw){
  const o={traco_id:"",cp:"",idade_dias:"",data_moldagem:"",hora_moldagem:"",data_ruptura:"",qr_raw:raw};
  raw.split("|").forEach(p=>{
    const [k,v]=p.split("=");
    if(!v)return;
    if(k=="traco")o.traco_id=v;
    if(k=="cp")o.cp=v;
    if(k=="idade")o.idade_dias=v;
    if(k=="mold")o.data_moldagem=v;
    if(k=="hora")o.hora_moldagem=v;
    if(k=="rupt")o.data_ruptura=v;
  });
  return o;
}

function preview(p){
  $("pv_traco").textContent=p.traco_id;
  $("pv_cp").textContent=p.cp;
  $("pv_idade").textContent=p.idade_dias;
  $("pv_mold").textContent=p.data_moldagem;
  $("pv_hora").textContent=p.hora_moldagem;
  $("pv_rupt").textContent=p.data_ruptura;
}

async function send(){
  const mpa=$("mpaInput").value.replace(",",".");
  if(!mpa){ status("MPA obrigatÃ³rio","err"); return; }

  status("salvando...","warn");

  const res=await fetch(WEBAPP_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({
      operador,
      mpa,
      ...lastParsed,
      qr_raw:lastRaw,
      timestamp:new Date().toISOString()
    })
  });

  const r=await res.text();
  if(r.includes("ok")){
    status("gravado na planilha","ok");
    $("btnSave").disabled=true;
    $("mpaInput").value="";
  }else{
    status("erro ao gravar","err");
  }
}
</script>
</body>
</html>
