<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Leitura CP ‚Ä¢ Registro MPA</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#070A12">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- ajuda a reduzir cache do navegador (PWA ainda pode cachear via SW) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg1:#001D3D; --bg2:#001D3D;
      --card:rgba(15,35,80,.8); --card2:rgba(10,25,60,.85);
      --line:#1E4B8B; --line2:#2B5FA3;
      --text:#F3F6FF; --muted:#B9C4D0;
      --ok:#22C55E; --err:#EF4444; --warn:#F59E0B;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{ margin:0; color:var(--text); background: #001D3D; }
    .wrap{ max-width: 700px; margin:0 auto; padding: 18px; }
    .title{ font-size:28px; font-weight: 900; }
    .subtitle{ color:var(--muted); font-size:15px; margin-bottom:12px; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
      display:grid;
      gap:14px;
      font-size:15px;
    }

    .ops{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      padding:16px;
      border-radius:16px;
      border:1px solid var(--line2);
      background:var(--card2);
      color:var(--text);
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      flex:1;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn.primary{ background:#696969; border-color:#696969; }
    .btn.good{ background:#16A34A; border-color:#16A34A; }
    .btn.sel{ outline:3px solid #A9A9A9; }
    .btn.dark{ background:#0B1220; border-color:#0B1220; }

    #reader{
      width:100%;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--line);
      background:#000;
    }

    .status{ font-weight:900; font-size:16px; padding:2px 4px; }
    .ok{ color:var(--ok); }
    .err{ color:var(--err); }
    .warn{ color:var(--warn); }

    .kv{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ background:var(--card2); border:1px solid var(--line2); border-radius:14px; padding:12px; }
    .label{ font-size:15px; color:var(--muted); }
    .value{ font-size:28px; font-weight:900; margin-top:6px; }

    .mpaInput{
      font-size:34px;
      font-weight:900;
      padding:18px;
      border-radius:16px;
      border:1px solid var(--line2);
      background:#050814;
      color:var(--text);
      width:100%;
      outline:none;
    }

    .pillRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:24px 36px;
      border-radius:999px;
      border:1px solid var(--line2);
      background:rgba(5,8,20,.55);
      font-weight:900;
      font-size:28px;
    }
    .dot{ width:12px; height:12px; border-radius:999px; background:var(--muted); }
    .dot.ok{ background: var(--ok); }
    .dot.warn{ background: var(--warn); }
    .dot.err{ background: var(--err); }
    .mini{ color:var(--muted); font-weight:800; }

    .modal{
      display:none;
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,.7);
      z-index:9999;
      align-items:center;
      justify-content:center;
    }
    .modal.show{ display:flex; }
    .modal-content{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      padding:32px;
      max-width:400px;
      text-align:center;
      box-shadow:var(--shadow);
    }
    .modal-title{
      font-size:28px;
      font-weight:900;
      margin-bottom:16px;
      color:var(--ok);
    }
    .modal-text{
      font-size:18px;
      margin-bottom:24px;
      color:var(--text);
    }
    .modal-btn{
      padding:16px 32px;
      border-radius:16px;
      border:none;
      background:var(--ok);
      color:#000;
      font-weight:900;
      font-size:18px;
      cursor:pointer;
    }
    .modal-btn:active{ opacity:0.8; }
  </style>

  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
<div class="wrap">
  <div class="title">üì∑ QR Concreto</div>
  <div class="subtitle">Ler QR ‚Üí Digitar MPA ‚Üí Status autom√°tico (Min/Max) ‚Üí Salvar</div>

  <div class="card">

    <div class="ops" id="ops">
      <button class="btn" data-op="Gabriel">Gabriel</button>
      <button class="btn" data-op="Tawan">Tawan</button>
      <button class="btn" data-op="Ricardo">Ricardo</button>
    </div>

    <button class="btn primary" id="btnStart">Ler QR</button>

    <div id="reader" style="display:none"></div>

    <div>Status: <span id="status" class="status">aguardando</span></div>

    <div class="kv">
      <div class="field"><div class="label">Tra√ßo</div><div id="pv_traco" class="value">‚Äî</div></div>
      <div class="field"><div class="label">Moldagem</div><div id="pv_mold" class="value">‚Äî</div></div>
      <div class="field"><div class="label">Idade</div><div id="pv_idade" class="value">‚Äî</div></div>
      <div class="field"><div class="label">CP</div><div id="pv_cp" class="value">‚Äî</div></div>
      <div class="field"><div class="label">Hora</div><div id="pv_hora" class="value">‚Äî</div></div>
      <div class="field"><div class="label">Ruptura</div><div id="pv_rupt" class="value">‚Äî</div></div>
    </div>

    <input id="mpaInput" class="mpaInput" placeholder="MPA (ex: 21,5)" />

    <div class="pillRow">
      <div class="pill">
        <span id="dotMeta" class="dot"></span>
        <span id="metaTxt">Meta: ‚Äî</span>
      </div>
      <div class="pill mini" id="helpTxt">Digite o MPA para ver o status.</div>
    </div>

    <button class="btn good" id="btnSave" disabled>üíæ SALVAR</button>

    <!-- ‚úÖ LINK PARA DASHBOARD -->
    <a class="btn dark" id="btnDash" href="#" target="_blank" rel="noopener">üìä ABRIR DASHBOARD</a>

  </div>
</div>

<div class="modal" id="modalSucesso">
  <div class="modal-content">
    <div class="modal-title">‚úÖ Sucesso!</div>
    <div class="modal-text">Registro foi salvo com sucesso.</div>
    <button class="modal-btn" onclick="fecharModal()">OK</button>
  </div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwmAfqKqDuK67pHUksgmEv3z0NyvVuLWRfrYtyTEbL_2nDwp0bBIl88FEYdnQ2XjTuI/exec";
const DASH_URL = WEBAPP_URL + "?view=dashboard";

document.getElementById("btnDash").href = DASH_URL;

/**
 * Faixa esperada (Min/Max)
 * 24h = 1 dia
 */
const META_FAIXA = {
  1:  { min: 8,  max: 14 },
  3:  { min: 16, max: 24 },
  7:  { min: 22, max: 32 },
  28: { min: 32, max: 42 }
};

let operador = "";
let lastRaw = "";
let lastParsed = null;
let qr = null;

const $ = id => document.getElementById(id);
const setStatus = (t,c="") => { $("status").textContent=t; $("status").className="status "+c; };

function fecharModal(){
  $("modalSucesso").classList.remove("show");
}

// for√ßa pegar vers√£o nova por abertura (evita ‚Äúficar preso‚Äù no cache/PWA)
(async function forceFreshOnOpen(){
  try{
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const reg of regs) await reg.update();
    }
    const key = "cache_bust_done";
    if (!sessionStorage.getItem(key) && 'caches' in window) {
      sessionStorage.setItem(key, "1");
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
      location.reload(true);
    }
  } catch(e){}
})();

document.querySelectorAll("#ops .btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("#ops .btn").forEach(x=>x.classList.remove("sel"));
    b.classList.add("sel");
    operador=b.dataset.op;
    $("btnSave").disabled = !canSave(mpaNumber());
  };
});

$("btnStart").onclick=async()=>{
  if(!operador){ setStatus("selecione operador","err"); return; }
  $("reader").style.display="block";
  qr ??= new Html5Qrcode("reader");

  await qr.start({facingMode:"environment"},{fps:10,qrbox:300},async (txt)=>{
    await qr.stop();
    $("reader").style.display="none";

    lastRaw = txt;
    lastParsed = parseQR(txt);
    preview(lastParsed);

    $("mpaInput").value = "";
    updateMPAStatus();
    $("btnSave").disabled = true;

    setStatus("QR lido ‚Ä¢ digite o MPA","warn");
    $("mpaInput").focus();
  });
};

$("mpaInput").addEventListener("input", ()=>{
  updateMPAStatus();
  $("btnSave").disabled = !canSave(mpaNumber());
});

$("btnSave").onclick=()=>send();

function parseQR(raw){
  const o={traco_id:"",cp:"",idade_dias:"",data_moldagem:"",hora_moldagem:"",data_ruptura:"",qr_raw:raw};
  raw.split("|").forEach(p=>{
    const [k,v]=p.split("=");
    if(!v)return;
    if(k=="traco")o.traco_id=v;
    if(k=="cp")o.cp=v;
    if(k=="idade")o.idade_dias=v;
    if(k=="mold")o.data_moldagem=v;
    if(k=="hora")o.hora_moldagem=v;
    if(k=="rupt")o.data_ruptura=v;
  });
  return o;
}

function formatData(data){
  if(!data) return "‚Äî";
  if(String(data).includes("-")) {
    const [y,m,d]=String(data).split("-");
    return `${d}/${m}/${y}`;
  }
  return String(data);
}

function preview(p){
  $("pv_traco").textContent = p.traco_id || "‚Äî";
  $("pv_cp").textContent    = p.cp || "‚Äî";
  $("pv_idade").textContent = p.idade_dias || "‚Äî";
  $("pv_mold").textContent  = formatData(p.data_moldagem);
  $("pv_hora").textContent  = p.hora_moldagem || "‚Äî";
  $("pv_rupt").textContent  = formatData(p.data_ruptura);
}

function mpaNumber(){
  const s = String($("mpaInput").value||"").trim().replace(",",".");
  const cleaned = s.replace(/[^0-9.]/g,"");
  if(!cleaned) return null;
  const i = cleaned.indexOf(".");
  const normalized = (i === -1) ? cleaned : (cleaned.slice(0,i+1) + cleaned.slice(i+1).replace(/\./g,""));
  const v = Number(normalized);
  return Number.isFinite(v) ? v : null;
}

function calcMetaStatus(mpa){
  const idade = Number(lastParsed?.idade_dias || "");
  const meta = META_FAIXA[idade];
  if(!meta) return { status:"SEM_META", label:"Meta: ‚Äî (idade sem faixa)", dot:"warn", metaMin:"", metaMax:"" };
  if(mpa == null) return { status:"SEM_MPA", label:`Meta: ${meta.min}‚Äì${meta.max} MPa`, dot:"warn", metaMin:meta.min, metaMax:meta.max };

  if(mpa < meta.min) return { status:"ABAIXO", label:`Meta: ${meta.min}‚Äì${meta.max} ‚Ä¢ ABAIXO ‚ùå`, dot:"err", metaMin:meta.min, metaMax:meta.max };
  if(mpa > meta.max) return { status:"ACIMA",  label:`Meta: ${meta.min}‚Äì${meta.max} ‚Ä¢ ACIMA ‚ö†Ô∏è`, dot:"warn", metaMin:meta.min, metaMax:meta.max };
  return { status:"DENTRO", label:`Meta: ${meta.min}‚Äì${meta.max} ‚Ä¢ DENTRO ‚úÖ`, dot:"ok", metaMin:meta.min, metaMax:meta.max };
}

function updateMPAStatus(){
  const mpa = mpaNumber();
  const s = calcMetaStatus(mpa);
  $("metaTxt").textContent = s.label;
  $("dotMeta").className = "dot " + (s.dot || "");
  $("helpTxt").textContent = (mpa == null) ? "Digite o MPA para ver o status." : "Clique em SALVAR.";
}

function canSave(mpa){
  if(!operador) return false;
  if(!lastParsed) return false;
  if(mpa == null || mpa <= 0 || mpa >= 200) return false;
  if(!lastParsed.traco_id || !lastParsed.cp || !lastParsed.idade_dias) return false;
  return true;
}

async function send(){
  const mpa = mpaNumber();
  if(!canSave(mpa)){ setStatus("verifique QR + MPA + operador","err"); return; }

  const meta = calcMetaStatus(mpa);

  setStatus("salvando...","warn");
  $("btnSave").disabled = true;

  const url = WEBAPP_URL + "?t=" + Date.now();

  try{
    const res = await fetch(url,{
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({
        operador,
        mpa: String(mpa),
        status_meta: meta.status,
        meta_min: meta.metaMin,
        meta_max: meta.metaMax,
        ...lastParsed,
        qr_raw:lastRaw,
        timestamp:new Date().toISOString()
      })
    });

    const text = await res.text();

    // tenta parsear JSON (se o apps script retornou JSON)
    let data = null;
    try { data = JSON.parse(text); } catch(e) {}

    if(text.includes("ok") || (data && data.ok)){
      setStatus("gravado na planilha ‚úÖ","ok");
      $("mpaInput").value="";
      $("btnSave").disabled = true;
      updateMPAStatus();

      // ‚úÖ atualiza link do dashboard (se vier path no JSON)
      if(data && data.dashboard_path){
        $("btnDash").href = WEBAPP_URL + data.dashboard_path;
      } else {
        $("btnDash").href = DASH_URL;
      }

      $("modalSucesso").classList.add("show");
    }else{
      setStatus("erro ao gravar","err");
      $("btnSave").disabled = false;
    }
  }catch(e){
    setStatus("erro envio: " + (e?.message || e), "err");
    $("btnSave").disabled = false;
  }
}
</script>
</body>
</html>
