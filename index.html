<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QR Concreto ‚Ä¢ Registro MPA</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0B0F1A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      /* NOVA PALETA (mais ‚Äúpremium‚Äù, fundo escuro com contraste) */
      --bg1:#070A12;
      --bg2:#0B1020;
      --card:#0F1630;
      --card2:#0B1226;
      --line:#1E2A4A;
      --line2:#2A3A66;

      --text:#F3F6FF;
      --muted:#A9B4D0;

      --blue:#3B82F6;
      --ok:#22C55E;
      --err:#EF4444;
      --warn:#F59E0B;

      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% -10%, #16224a 0%, transparent 60%),
                  radial-gradient(900px 500px at 120% 10%, #1a2b5d 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    .wrap{ max-width: 650px; margin:0 auto; padding: 18px; padding-bottom: 28px; }

    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin: 8px 0 14px;
    }
    .title{
      font-size: 20px;               /* FONTE MAIOR */
      font-weight: 900;
      letter-spacing: .2px;
    }
    .subtitle{
      margin-top: 4px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.2rem;
    }

    .pill{
      padding:8px 12px;
      border-radius:999px;
      background: rgba(15,22,48,.7);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      display:flex; align-items:center; gap:8px;
      white-space: nowrap;
    }
    .dot{ width:9px; height:9px; border-radius:999px; background:var(--muted); }

    .card{
      background: rgba(15,22,48,.85);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .grid{ display:grid; gap:12px; }

    .hint{
      color:var(--muted);
      font-size: 14px;              /* FONTE MAIOR */
      line-height: 1.25rem;
    }

    .ops{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      border:1px solid var(--line2);
      background: rgba(11,18,38,.95);
      color:var(--text);
      padding:14px 14px;            /* BOT√ÉO MAIOR */
      border-radius: 16px;
      font-weight: 900;
      cursor:pointer;
      flex: 1;
      min-width: 150px;
      user-select:none;
      letter-spacing:.2px;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{ background: linear-gradient(180deg, #3B82F6, #2563EB); border-color:#2563EB; }
    .btn.good{ background: linear-gradient(180deg, #22C55E, #16A34A); border-color:#16A34A; }
    .btn.sel{ outline: 3px solid rgba(96,165,250,.75); }

    .row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }

    #reader{
      width:100%;
      overflow:hidden;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background:#000;
    }

    .statusLine{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .status{ font-weight: 1000; font-size: 15px; letter-spacing:.2px; }
    .status.ok{ color: var(--ok); }
    .status.err{ color: var(--err); }
    .status.warn{ color: var(--warn); }

    .divider{ height:1px; background: rgba(30,42,74,.85); margin: 6px 0; }

    .kv{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .field{
      background: rgba(11,18,38,.9);
      border:1px solid var(--line2);
      border-radius: 16px;
      padding:12px;
    }
    .label{ color:var(--muted); font-size: 12px; }
    .value{ font-weight: 1000; margin-top:6px; font-size: 18px; letter-spacing:.2px; } /* FONTE BEM MAIOR */

    .mpaBox{
      background: rgba(11,18,38,.9);
      border:1px solid var(--line2);
      border-radius: 18px;
      padding: 14px;
      display:grid;
      gap:10px;
    }
    .mpaInput{
      width: 100%;
      font-size: 30px;              /* FONTE MUITO MAIOR */
      font-weight: 1000;
      padding: 16px 16px;
      border-radius: 16px;
      border:1px solid var(--line2);
      background: rgba(7,10,18,.85);
      color:var(--text);
      outline:none;
      letter-spacing:.4px;
    }
    .mpaInput::placeholder{ color:#7c8bb4; font-weight:900; }

    .mpaHelp{ color:var(--muted); font-size: 13px; line-height: 1.2rem; }

    .log{ display:grid; gap:10px; }
    .logItem{
      padding:12px;
      border-radius: 16px;
      background: rgba(11,18,38,.9);
      border:1px solid var(--line2);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;               /* MAIOR */
      color:#d6ddf4;
      white-space:pre-wrap;
      word-break:break-word;
    }

    .hidden{ display:none; }
    .footerHint{ margin-top: 10px; color: var(--muted); font-size: 12px; line-height: 1.25rem; text-align:center; }
  </style>

  <!-- Scanner QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">üì∑ QR Concreto ‚Ä¢ Registro MPA</div>
        <div class="subtitle">Ler QR ‚Üí Digitar MPA ‚Üí Salvar na planilha</div>
      </div>

      <div class="pill">
        <span class="dot" id="connDot"></span>
        <span id="connTxt">offline</span>
      </div>
    </div>

    <div class="card grid">
      <div class="hint">
        <b>Fluxo:</b> selecione operador ‚Üí <b>Ler QR</b> ‚Üí digite <b>MPA</b> ‚Üí clique <b>SALVAR</b>.
      </div>

      <div class="ops" id="ops">
        <button class="btn" data-op="Gabriel">Gabriel</button>
        <button class="btn" data-op="Tawan">Tawan</button>
        <button class="btn" data-op="Ricardo">Ricardo</button>
      </div>

      <div class="row">
        <button class="btn primary" id="btnStart">Ler QR</button>
        <button class="btn" id="btnReset">Nova Leitura</button>
      </div>

      <div id="reader" class="hidden"></div>

      <div class="statusLine">
        <div class="hint">Status: <span id="status" class="status">aguardando</span></div>
        <div class="hint">Operador: <b id="opView">‚Äî</b></div>
      </div>

      <div class="divider"></div>

      <div class="hint"><b>Pr√©via do QR</b></div>
      <div class="kv">
        <div class="field"><div class="label">Tra√ßo_ID</div><div class="value" id="pv_traco">‚Äî</div></div>
        <div class="field"><div class="label">CP</div><div class="value" id="pv_cp">‚Äî</div></div>
        <div class="field"><div class="label">Data Moldagem</div><div class="value" id="pv_mold">‚Äî</div></div>
        <div class="field"><div class="label">Hora Moldagem</div><div class="value" id="pv_hora">‚Äî</div></div>
        <div class="field"><div class="label">Idade (dias)</div><div class="value" id="pv_idade">‚Äî</div></div>
        <div class="field"><div class="label">Data Ruptura</div><div class="value" id="pv_rupt">‚Äî</div></div>
      </div>

      <div class="divider"></div>

      <div class="mpaBox">
        <div class="row">
          <div class="hint"><b>MPA (digitado manualmente)</b></div>
          <div class="hint"><b>Obrigat√≥rio</b></div>
        </div>

        <input
          id="mpaInput"
          class="mpaInput"
          inputmode="decimal"
          autocomplete="off"
          placeholder="Ex: 21,5"
        />

        <div class="mpaHelp">
          Aceita v√≠rgula ou ponto. Ex.: <b>21,5</b> = <b>21.5</b>.  
          O bot√£o <b>SALVAR</b> s√≥ libera quando QR + MPA estiverem ok.
        </div>

        <button class="btn good" id="btnSave" disabled>‚úÖ SALVAR NA PLANILHA</button>
      </div>

      <div class="divider"></div>

      <div class="hint"><b>√öltimas leituras</b></div>
      <div id="logBox" class="log"></div>

      <div class="footerHint">
        Se voc√™ atualizou o site e n√£o mudou no celular, atualize o cache (instru√ß√µes abaixo).
      </div>
    </div>
  </div>

<script>
/***********************
 * CONFIGURA√á√ïES
 ***********************/
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyWldzFD4Vhk6FBjb2cEPOHRcG_XYz_8OTJzLt4D3bHyEiC7fKOV0ihl58Qb40oBAWk/exec";
const API_TOKEN  = "qrConcreto_2026_Concrefer@01"; // ‚úÖ SEU TOKEN

/***********************
 * ESTADO
 ***********************/
let selectedOp = "";
let html5Qr = null;
let scanning = false;

let lastRaw = "";
let lastParsed = null;

/***********************
 * HELPERS
 ***********************/
const $ = (id) => document.getElementById(id);

function setStatus(text, type="") {
  const el = $("status");
  el.textContent = text;
  el.className = "status " + (type || "");
}

function setConn() {
  const online = navigator.onLine;
  $("connTxt").textContent = online ? "online" : "offline";
  $("connDot").style.background = online ? "#22C55E" : "#A9B4D0";
}
window.addEventListener("online", setConn);
window.addEventListener("offline", setConn);
setConn();

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function fillPreview(p) {
  $("pv_traco").textContent = p?.traco_id || "‚Äî";
  $("pv_cp").textContent    = p?.cp || "‚Äî";
  $("pv_mold").textContent  = p?.data_moldagem || "‚Äî";
  $("pv_hora").textContent  = p?.hora_moldagem || "‚Äî";
  $("pv_idade").textContent = (p?.idade_dias !== "" && p?.idade_dias != null) ? p.idade_dias : "‚Äî";
  $("pv_rupt").textContent  = p?.data_ruptura || "‚Äî";
}

function pushLog(entry) {
  const dt = new Date().toLocaleString();
  const div = document.createElement("div");
  div.className = "logItem";
  div.innerHTML = `
    <div class="hint"><b>${entry.ok ? "‚úÖ OK" : "‚ùå ERRO"}</b> ‚Ä¢ ${dt} ‚Ä¢ Op: <b>${escapeHtml(entry.operador || "")}</b> ‚Ä¢ MPA: <b>${escapeHtml(entry.mpa || "‚Äî")}</b></div>
    <div class="mono" style="margin-top:10px;">${escapeHtml(entry.raw || "")}</div>
  `;
  $("logBox").prepend(div);
  while ($("logBox").children.length > 6) $("logBox").removeChild($("logBox").lastChild);
}

function normalizaData(v) {
  if (!v) return "";
  const s = String(v).trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    const [y, m, d] = s.split("-");
    return `${d}/${m}/${y}`;
  }
  return s;
}

/***********************
 * PARSE DO QR (UNIVERSAL)
 * - key=value com separadores | ; \n ,
 *   ex: traco=21663|cp=2/2|idade=28|mold=2026-01-05|hora=13:24|rupt=2026-02-02
 * - fallback do texto da etiqueta (Tra√ßo: 21663 etc)
 ***********************/
function parseQR(raw) {
  const out = {
    traco_id: "",
    cp: "",
    data_moldagem: "",
    hora_moldagem: "",
    idade_dias: "",
    data_ruptura: "",
    qr_raw: raw
  };
  if (!raw) return out;

  const text = String(raw).replace(/\r/g, "");

  // 1) key=value
  const norm = text.replace(/\n/g, "|").replace(/;/g, "|").replace(/,/g, "|");
  const parts = norm.split("|").map(p => p.trim()).filter(Boolean);

  const kv = {};
  for (const p of parts) {
    const eq = p.indexOf("=");
    if (eq > 0) {
      const k = p.slice(0, eq).trim().toLowerCase();
      const v = p.slice(eq + 1).trim();
      if (k) kv[k] = v;
    }
  }

  const pick = (...keys) => {
    for (const k of keys) if (kv[k] != null && kv[k] !== "") return kv[k];
    return "";
  };

  const tracoKV = pick("traco", "tra√ßo", "traco_id", "tra√ßo_id");
  const cpKV    = pick("cp");
  const idadeKV = pick("idade", "idade_dias", "idade-dias");
  const moldKV  = pick("mold", "moldagem", "data_mold", "data_moldagem");
  const horaKV  = pick("hora", "hora_mold", "hora_moldagem");
  const ruptKV  = pick("rupt", "ruptura", "data_rupt", "data_ruptura");

  if (tracoKV || cpKV || idadeKV || moldKV || horaKV || ruptKV) {
    out.traco_id = tracoKV;
    out.cp = cpKV;
    out.idade_dias = idadeKV;
    out.hora_moldagem = horaKV;
    out.data_moldagem = normalizaData(moldKV);
    out.data_ruptura = normalizaData(ruptKV);
    return out;
  }

  // 2) fallback etiqueta
  const traco = text.match(/Tra√ßo:\s*([0-9]+)/i);
  if (traco) out.traco_id = traco[1];

  const cp = text.match(/CP:\s*([0-9\/]+)/i);
  if (cp) out.cp = cp[1];

  const mold = text.match(/Moldagem:\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4})/i);
  if (mold) out.data_moldagem = mold[1];

  const hora = text.match(/Hora:\s*([0-9]{2}:[0-9]{2})/i);
  if (hora) out.hora_moldagem = hora[1];

  const idade = text.match(/([0-9]+)\s*DIAS?/i);
  if (idade) out.idade_dias = idade[1];

  const rupt = text.match(/Ruptura:\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4})/i);
  if (rupt) out.data_ruptura = rupt[1];

  return out;
}

/***********************
 * MPA: normaliza√ß√£o e valida√ß√£o
 ***********************/
function normalizeMPA(input) {
  const s = String(input || "").trim().replace(",", ".");
  const cleaned = s.replace(/[^0-9.]/g, "");
  if (!cleaned) return "";
  const firstDot = cleaned.indexOf(".");
  if (firstDot !== -1) {
    const before = cleaned.slice(0, firstDot + 1);
    const after  = cleaned.slice(firstDot + 1).replace(/\./g, "");
    return before + after;
  }
  return cleaned;
}

function isValidMPA(mpaStr) {
  if (!mpaStr) return false;
  const v = Number(mpaStr);
  return Number.isFinite(v) && v > 0 && v < 200; // ajuste se quiser
}

function updateSaveButton() {
  const mpa = normalizeMPA($("mpaInput").value);
  const ok = !!lastParsed && !!lastRaw && isValidMPA(mpa);
  $("btnSave").disabled = !ok;
}

/***********************
 * OPERADOR
 ***********************/
document.querySelectorAll("#ops .btn").forEach(b => {
  b.addEventListener("click", () => {
    document.querySelectorAll("#ops .btn").forEach(x => x.classList.remove("sel"));
    b.classList.add("sel");
    selectedOp = b.dataset.op;
    $("opView").textContent = selectedOp;
    if ($("status").textContent === "selecione operador") setStatus("aguardando");
  });
});

/***********************
 * BOT√ïES
 ***********************/
$("btnStart").addEventListener("click", async () => {
  if (!selectedOp) {
    setStatus("selecione operador", "err");
    return;
  }
  startScan();
});

$("btnReset").addEventListener("click", () => {
  lastRaw = "";
  lastParsed = null;
  $("mpaInput").value = "";
  fillPreview(null);
  updateSaveButton();
  setStatus("aguardando");
});

$("mpaInput").addEventListener("input", updateSaveButton);

$("btnSave").addEventListener("click", async () => {
  const mpa = normalizeMPA($("mpaInput").value);
  if (!isValidMPA(mpa)) {
    setStatus("MPA inv√°lido", "err");
    return;
  }
  if (!lastParsed || !lastRaw) {
    setStatus("leia um QR primeiro", "err");
    return;
  }
  await sendToSheet(lastRaw, lastParsed, mpa);
});

/***********************
 * SCANNER
 ***********************/
async function startScan() {
  setStatus("abrindo c√¢mera...", "warn");
  $("btnStart").disabled = true;
  $("reader").classList.remove("hidden");

  if (!html5Qr) html5Qr = new Html5Qrcode("reader");

  try {
    scanning = true;

    const config = { fps: 12, qrbox: { width: 280, height: 280 } };
    const cams = await Html5Qrcode.getCameras();
    const backCam = cams && cams.length ? cams[cams.length - 1].id : undefined;

    await html5Qr.start(
      backCam,
      config,
      async (decodedText) => {
        await stopScan();

        const parsed = parseQR(decodedText);
        fillPreview(parsed);

        lastRaw = decodedText;
        lastParsed = parsed;

        // valida√ß√£o m√≠nima do QR
        if (!parsed.traco_id || !parsed.cp || !parsed.data_moldagem || !parsed.hora_moldagem) {
          setStatus("QR lido, mas faltam campos (verifique o QR)", "err");
          updateSaveButton();
          $("btnStart").disabled = false;
          return;
        }

        setStatus("QR lido ‚úÖ digite o MPA e clique SALVAR", "warn");
        $("mpaInput").focus();
        updateSaveButton();
        $("btnStart").disabled = false;
      },
      () => {}
    );

    setStatus("aponte para o QR", "warn");
  } catch (e) {
    scanning = false;
    $("btnStart").disabled = false;
    setStatus("erro c√¢mera: " + (e?.message || e), "err");
  }
}

async function stopScan() {
  try {
    if (html5Qr && scanning) {
      await html5Qr.stop();
      await html5Qr.clear();
    }
  } catch {}
  scanning = false;
  $("reader").classList.add("hidden");
}

/***********************
 * ENVIO
 ***********************/
async function sendToSheet(raw, parsed, mpaStr) {
  try {
    setStatus("salvando na planilha...", "warn");
    $("btnSave").disabled = true;
    $("btnStart").disabled = true;

    const payload = {
      token: API_TOKEN,
      timestamp: new Date().toISOString(),
      operador: selectedOp,
      mpa: mpaStr,
      ...parsed,
      qr_raw: raw
    };

    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));

    if (data.ok) {
      setStatus("gravado na planilha ‚úÖ", "ok");
      pushLog({ ok:true, raw, operador: selectedOp, mpa: mpaStr });

      // limpa pra pr√≥xima
      lastRaw = "";
      lastParsed = null;
      $("mpaInput").value = "";
      fillPreview(null);
      updateSaveButton();

    } else {
      setStatus("falhou: " + (data.error || "erro"), "err");
      pushLog({ ok:false, raw, operador: selectedOp, mpa: mpaStr });
      updateSaveButton();
    }
  } catch (e) {
    setStatus("erro envio: " + (e?.message || e), "err");
    pushLog({ ok:false, raw, operador: selectedOp, mpa: mpaStr });
    updateSaveButton();
  } finally {
    $("btnStart").disabled = false;
  }
}

/***********************
 * PWA (Service Worker)
 ***********************/
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}
</script>
</body>
</html>
